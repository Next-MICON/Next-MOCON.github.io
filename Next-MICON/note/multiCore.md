# マルチコア

## 考察

- OS レスマルチタスキング
  - 普段マルチタスクするときは OS がいるからいいよね，という話
- タスクの切り分け
  - マルチコア化が有効に働くために重要なファクター
  - タスク間の時空間的依存関係と，ハードウェア構成は共依存的である
- FPGA 上の並列処理
  - FPGA の並列処理は空間分割（本当？
  - タスクごとにアクセラレータを走らせてる
  - CPU を使わなくとも並列処理は実現できる
- FPGA 上の CPU
  - CPU としての性能は専用設計のマイコンに勝てるわけない
  - じゃあなぜ CPU が必要か
    - アクセラレータを作るのがめんどくさい
    - これは主目的ではないけど実用的
    - 高位合成でアクセラレータを生成できれば問題ない
  - 処理を主に実行するわけじゃない
  - 各モジュールのオーケストレーション
  - 各モジュールにインターフェイスを提供する
  - CPU はアスペクト指向的な処理に充てられるのがよさそう
    - 複数のアスペクトを同時に実行するとなるとめんどいなぁ
  - CPU は多様な処理をワンチップの FPGA で済ませたい場合に必要になりそう
- 高位合成
  - やべぇ
  - 高位合成できれば CPU いらんやろ
  - 高位合成書きてぇ…………

## コア間通信

![dualcore.svg](./img/dualcore.svg)

|            | 1      | 2      | 3    | 4    |
| ---------- | ------ | ------ | ---- | ---- |
| メモリ空間 | 独立   | 独立   | 独立 | 共有 |
| 共有メモリ | 全二重 | 半二重 |      | 単一 |

- メモリ空間

  - 独立
    - コアごとにメモリ空間を持っている
    - × : 別のコアの持つメモリ空間にアクセスするための処理が，複数のコアにまたがるがために，複雑な処理が要求される
      - あるモーターを複数のコアでドライブするなど
      - 複数のコアの処理をひとつのポートに出力
    - ○ : 各コアが自身のメモリ空間のみにアクセスするようなタスクを実行する限り，凝集性が高いコードを書くことができる
  - 共有
    - × : 排他制御のためにメモリアクセスが遅くなる可能性
    - ○ : 柔軟なマルチタスキングが可能（OS を使う場合に有効だと考えられる

- 共有メモリ
  - コア間で情報を受け渡すレジスタ（？メモリ？バッファ？）
  - 複数のコアが読むのは問題ない
  - 複数のコアが書く可能性があると排他制御が必要になる
  - 問題
    - 書き込みの排他制御
    - 意図せぬ変更
    - データの同一性の保証
    - ボトルネック，通信速度
  - 全二重
    - 送信用・受信用に分かれている
    - 共同編集はできない
- 割り込み
  - コア間で共有メモリの変更を通知するために割り込みを使う

## 例

- printf
  - 通信はひとつのポートで行われるはず
